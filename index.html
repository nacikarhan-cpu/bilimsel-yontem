import React, { useState, useEffect, useRef } from 'react';
import { Play, CheckCircle, RefreshCw, MessageCircle, Beaker, Search, ShieldCheck, HelpCircle, Eye, Target, TrendingUp } from 'lucide-react';

const App = () => {
  const [activeTab, setActiveTab] = useState('kesfet');
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [score, setScore] = useState(0);
  const [showFeedback, setShowFeedback] = useState(false);
  const [feedbackType, setFeedbackType] = useState(null);
  const [missedCategories, setMissedCategories] = useState(new Set());
  const canvasRef = useRef(null);
  const containerRef = useRef(null);
  const audioContextRef = useRef(null);

  const steps = [
    { id: 1, title: 'Problemin Belirlenmesi', desc: 'Araştırılacak sorunun net bir şekilde ortaya konması.', color: '#3b82f6' },
    { id: 2, title: 'Gözlem ve Veri Toplama', desc: 'Nitel ve Nicel verilerin toplanması.', color: '#10b981' },
    { id: 3, title: 'Hipotez Kurma', desc: 'Geçici çözüm yolu önerilmesi.', color: '#f59e0b' },
    { id: 4, title: 'Tahmin Yürütme', desc: '"Eğer... ise..." çıkarımları.', color: '#8b5cf6' },
    { id: 5, title: 'Kontrollü Deney', desc: 'Değişkenlerin test edilmesi.', color: '#ef4444' },
    { id: 6, title: 'Analiz ve Sonuç', desc: 'Hipotezin değerlendirilmesi.', color: '#06b6d4' }
  ];

  const recommendations = {
    'Gözlem': 'Doğanın alfabesini okurken daha dikkatli olmalısın. Nicel ve nitel arasındaki farkı iyi kavra.',
    'Hipotez': 'Sorunlara geçici ama mantıklı çözümler üretme becerini biraz daha zorlamalısın.',
    'Deney Tasarımı': 'Değişkenleri kontrol altında tutma disiplinini geliştirmelisin. Kontrol grubunu asla unutma!',
    'Bilimsel Süreç': 'Bilimin o sabırlı ve döngüsel doğasını, basamakların hiyerarşisini tekrar gözden geçir.'
  };

  const scientistTraits = [
    { title: 'Meraklı Olma', icon: <HelpCircle size={20} />, desc: 'Doğayı sürekli sorgular ve "Neden?" diye sorar.' },
    { title: 'Objektiflik', icon: <ShieldCheck size={20} />, desc: 'Önyargılarından arınmış, verilere sadık kalır.' },
    { title: 'Şüphecilik', icon: <Search size={20} />, desc: 'Her bilgiyi kanıtlarla sınar, körü körüne inanmaz.' },
    { title: 'Gözlemcilik', icon: <Eye size={20} />, desc: 'Ayrıntıları fark eder ve sistemli kayıt tutar.' },
    { title: 'Dürüstlük', icon: <CheckCircle size={20} />, desc: 'Verileri olduğu gibi paylaşır, sonuçları çarpıtmaz.' },
    { title: 'Sabır ve Azim', icon: <RefreshCw size={20} />, desc: 'Deneyler başarısız olsa da pes etmeden devam eder.' }
  ];

  const questions = [
    {
      q: "Kontrollü bir deneyde sonuçlar hipotezi desteklemezse ilk yapılması gereken nedir?",
      options: ["Deneyi iptal etmek", "Verilere göre hipotezi yenilemek", "Tahmin basamağını atlamak", "Teori ilan etmek"],
      correct: 1,
      category: 'Hipotez',
      hint: "Naci Hoca Tüyosu: Hipotez terk edilmez, eldeki verilere göre güncellenir!"
    },
    {
      q: "Aşağıdakilerden hangisi bir 'Nicel Gözlem' örneğidir?",
      options: ["Çiçeğin rengi çok canlı", "Su bugün çok soğuk", "Bitki boyu 15 cm uzadı", "Hava oldukça nemli"],
      correct: 2,
      category: 'Gözlem',
      hint: "Ölçüme dayalı gözlemler her zaman daha objektiftir."
    },
    {
      q: "Araştırmacının doğrudan değiştirdiği faktöre ne denir?",
      options: ["Bağımlı Değişken", "Kontrol Grubu", "Bağımsız Değişken", "Sabit Değişken"],
      correct: 2,
      category: 'Deney Tasarımı',
      hint: "Değişen 'Neden' bağımsızdır, sonuç ise ona bağımlıdır."
    },
    {
      q: "Hipoteze dayalı olarak kurulan 'Eğer... ise...' cümleleri hangi basamağı temsil eder?",
      options: ["Tahmin", "Gözlem", "Analiz", "Veri Toplama"],
      correct: 0,
      category: 'Hipotez',
      hint: "Tahmin (Prediction), mantıksal bir çıkarım sürecidir."
    },
    {
      q: "Eldeki verilere dayalı kurulan geçici çözüm yoluna ne denir?",
      options: ["Teori", "Kanun", "Hipotez", "Gözlem"],
      correct: 2,
      category: 'Hipotez',
      hint: "Sınanabilir bir ifade olmalıdır."
    },
    {
      q: "Test edilen faktör dışındaki tüm şartların aynı tutulduğu grup hangisidir?",
      options: ["Deney Grubu", "Kontrol Grubu", "Hipotez Grubu", "Analiz Grubu"],
      correct: 1,
      category: 'Deney Tasarımı',
      hint: "Karşılaştırma yapmak için standart bir grup gereklidir."
    },
    {
      q: "Nitel gözlemler için hangisi doğrudur?",
      options: ["Kesin sonuç bildirir", "Hata payı çok düşüktür", "Beş duyu organı ile yapılır", "Herkes için aynıdır"],
      correct: 2,
      category: 'Gözlem',
      hint: "Nitel gözlem kişiden kişiye değişebilir."
    },
    {
      q: "Deney sonuçları hipotezi doğruluyorsa, genellikle bir sonraki adım nedir?",
      options: ["Hipotezi terk etmek", "Sonuçları başkalarıyla paylaşmak", "Gözlemleri silmek", "Hipotezi tersine çevirmek"],
      correct: 1,
      category: 'Bilimsel Süreç',
      hint: "Bilim paylaşarak büyür; tekrarlanabilirlik esastır."
    },
    {
      q: "Gerçekliği kanıtlanmış, geniş kapsamlı açıklamalara ne ad verilir?",
      options: ["Veri", "Teori", "Tahmin", "Deney"],
      correct: 1,
      category: 'Bilimsel Süreç',
      hint: "Teoriler, 'neden' ve 'nasıl' sorularına kapsamlı yanıtlar arar."
    },
    {
      q: "Bilimsel yöntemin ilk basamağı aşağıdakilerden hangisidir?",
      options: ["Hipotez kurmak", "Tahmin yapmak", "Problemi belirlemek", "Deney yapmak"],
      correct: 2,
      category: 'Bilimsel Süreç',
      hint: "Önce neyi aradığımızı bilmeliyiz."
    }
  ];

  const playSound = (freq, type, duration) => {
    try {
      if (!audioContextRef.current) {
        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
      }
      const ctx = audioContextRef.current;
      if (ctx.state === 'suspended') ctx.resume();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.05, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
      osc.start();
      osc.stop(ctx.currentTime + duration);
    } catch (e) {}
  };

  const playCorrect = () => playSound(880, 'sine', 0.2);
  const playWrong = () => playSound(110, 'triangle', 0.4);

  useEffect(() => {
    if (activeTab === 'kesfet' && canvasRef.current && containerRef.current) {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext('2d');
      
      const draw = (width, height) => {
        if (!ctx) return;
        ctx.clearRect(0, 0, width, height);
        const centerX = width / 2;
        const boxW = Math.min(240, width * 0.85);
        const boxH = 50;
        const gap = 45;

        steps.forEach((s, i) => {
          const y = 30 + (boxH + gap) * i;
          
          ctx.fillStyle = s.color;
          ctx.beginPath();
          const r = 10;
          ctx.moveTo(centerX - boxW / 2 + r, y);
          ctx.lineTo(centerX + boxW / 2 - r, y);
          ctx.quadraticCurveTo(centerX + boxW / 2, y, centerX + boxW / 2, y + r);
          ctx.lineTo(centerX + boxW / 2, y + boxH - r);
          ctx.quadraticCurveTo(centerX + boxW / 2, y + boxH, centerX + boxW / 2 - r, y + boxH);
          ctx.lineTo(centerX - boxW / 2 + r, y + boxH);
          ctx.quadraticCurveTo(centerX - boxW / 2, y + boxH, centerX - boxW / 2, y + boxH - r);
          ctx.lineTo(centerX - boxW / 2, y + r);
          ctx.quadraticCurveTo(centerX - boxW / 2, y, centerX - boxW / 2 + r, y);
          ctx.closePath();
          ctx.fill();

          ctx.fillStyle = '#fff';
          ctx.font = 'bold 12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(`${i + 1}. ${s.title}`, centerX, y + 30);

          if (i < steps.length - 1) {
            ctx.strokeStyle = '#e2e8f0';
            ctx.setLineDash([]);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX, y + boxH);
            ctx.lineTo(centerX, y + boxH + gap);
            ctx.stroke();
          }

          if (i === 4) { // Kontrollü Deney -> Hipotez Geri Dönüş
            ctx.setLineDash([6, 4]);
            ctx.strokeStyle = '#f43f5e';
            ctx.beginPath();
            ctx.moveTo(centerX + boxW / 2, y + 25);
            ctx.bezierCurveTo(centerX + boxW * 1.1, y + 25, centerX + boxW * 1.1, y - 180, centerX + boxW / 2, y - 180);
            ctx.stroke();
          }
        });
      };

      const resizeObserver = new ResizeObserver(entries => {
        for (let entry of entries) {
          const { width } = entry.contentRect;
          const height = 650;
          canvas.width = width;
          canvas.height = height;
          draw(width, height);
        }
      });

      resizeObserver.observe(containerRef.current);
      return () => resizeObserver.disconnect();
    }
  }, [activeTab]);

  const handleAnswer = (idx) => {
    if (showFeedback) return;
    const currentQ = questions[currentQuestion];
    const isCorrect = idx === currentQ.correct;
    setShowFeedback(true);
    setFeedbackType(isCorrect ? 'correct' : 'wrong');
    
    if (isCorrect) {
      setScore(s => s + 1);
      playCorrect();
    } else {
      playWrong();
      setMissedCategories(prev => new Set(prev).add(currentQ.category));
    }

    setTimeout(() => {
      if (currentQuestion < questions.length - 1) {
        setCurrentQuestion(q => q + 1);
        setShowFeedback(false);
      } else {
        setActiveTab('ozet');
      }
    }, 1500);
  };

  const restartQuiz = () => {
    setCurrentQuestion(0);
    setScore(0);
    setMissedCategories(new Set());
    setActiveTab('kesfet');
  };

  return (
    <div className="min-h-screen bg-white text-slate-900 font-sans selection:bg-blue-100 overflow-x-hidden">
      <header className="bg-white border-b border-slate-100 sticky top-0 z-50">
        <div className="max-w-4xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-200">
              <Beaker size={24} />
            </div>
            <div>
              <h1 className="text-xl font-bold text-slate-800 tracking-tight">Bilim Laboratuvarı</h1>
              <p className="text-[10px] text-blue-600 font-black uppercase tracking-widest">Tasarım: Naci Karhan</p>
            </div>
          </div>
          <nav className="flex gap-2 bg-slate-50 p-1 rounded-2xl border border-slate-100 overflow-x-auto max-w-full no-scrollbar">
            {['kesfet', 'dene', 'ozet'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-6 py-2 rounded-xl text-[11px] font-black transition-all duration-300 uppercase tracking-wider whitespace-nowrap ${
                  activeTab === tab ? 'bg-white text-blue-600 shadow-sm border border-slate-100' : 'text-slate-400 hover:text-slate-600'
                }`}
              >
                {tab === 'kesfet' ? 'KEŞFET' : tab === 'dene' ? 'KENDİNİ DENE' : 'ÖZET'}
              </button>
            ))}
          </nav>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-6 py-8 md:py-12">
        {activeTab === 'kesfet' && (
          <div className="grid md:grid-cols-2 gap-8 md:gap-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
            <div ref={containerRef} className="bg-white p-4 md:p-8 rounded-[32px] shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden min-h-[650px]">
              <canvas ref={canvasRef} className="w-full block" />
            </div>
            <div className="space-y-6">
              <div className="bg-slate-900 p-8 rounded-[32px] text-white shadow-xl overflow-hidden group relative">
                <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                   <Beaker size={64} />
                </div>
                <p className="text-sm font-light leading-relaxed italic opacity-90 relative z-10">
                  "Bilim, sadece cevaplar bulmak değil, doğru soruları sormaktır. Hipoteziniz verilerle uyuşmazsa, gerçekliğe giden yeni bir yol keşfetmişsiniz demektir."
                </p>
                <div className="mt-4 flex items-center gap-2 relative z-10">
                   <div className="w-8 h-[1px] bg-blue-500"></div>
                   <span className="text-[10px] font-bold uppercase tracking-widest text-blue-400">Naci Karhan</span>
                </div>
              </div>
              <div className="grid gap-3">
                {steps.map(s => (
                  <div key={s.id} className="p-4 bg-white rounded-2xl border border-slate-100 hover:border-blue-200 hover:shadow-lg transition-all cursor-default group">
                    <div className="flex items-center gap-4">
                      <span className="text-xs font-black w-8 h-8 rounded-full flex items-center justify-center bg-slate-50 text-slate-300 group-hover:bg-blue-600 group-hover:text-white transition-all">0{s.id}</span>
                      <div>
                        <h4 className="font-bold text-sm text-slate-800 tracking-tight">{s.title}</h4>
                        <p className="text-[11px] text-slate-400 leading-tight mt-0.5">{s.desc}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'dene' && (
          <div className="max-w-xl mx-auto animate-in zoom-in-95 duration-500">
            <div className="bg-white rounded-[40px] shadow-2xl shadow-slate-200 border border-slate-100 overflow-hidden">
              <div className="bg-slate-50 h-2">
                 <div className="bg-blue-600 h-full transition-all duration-700 ease-out" style={{width: `${((currentQuestion+1)/questions.length)*100}%`}}></div>
              </div>
              <div className="p-6 md:p-10">
                <div className="flex justify-between items-center mb-10">
                   <span className="text-[10px] font-black text-blue-600 uppercase tracking-[0.2em]">Soru {currentQuestion + 1} / {questions.length}</span>
                   <div className="flex items-center gap-1">
                      <Target size={14} className="text-slate-300" />
                      <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{questions[currentQuestion].category}</span>
                   </div>
                </div>
                <h3 className="text-xl md:text-2xl font-bold text-slate-800 mb-10 leading-snug tracking-tight">{questions[currentQuestion].q}</h3>
                <div className="space-y-4">
                  {questions[currentQuestion].options.map((opt, i) => (
                    <button
                      key={i}
                      onClick={() => handleAnswer(i)}
                      disabled={showFeedback}
                      className={`w-full text-left p-4 md:p-5 rounded-2xl border-2 font-bold text-sm transition-all duration-300 ${
                        showFeedback && i === questions[currentQuestion].correct 
                        ? 'border-emerald-500 bg-emerald-50 text-emerald-700 shadow-lg shadow-emerald-100' 
                        : showFeedback && i !== questions[currentQuestion].correct
                        ? 'border-slate-50 text-slate-200'
                        : 'border-slate-50 bg-slate-50/50 hover:border-blue-500 hover:bg-white hover:shadow-xl hover:shadow-blue-50 text-slate-600'
                      }`}
                    >
                      <div className="flex items-center gap-4">
                         <span className="opacity-30 text-[10px]">{String.fromCharCode(65 + i)}</span>
                         {opt}
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'ozet' && (
          <div className="max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-8 duration-700 space-y-8 pb-20">
            <div className="bg-white p-6 md:p-12 rounded-[48px] shadow-2xl shadow-slate-200 border border-slate-100">
              <div className="text-center mb-12">
                <div className="inline-flex items-center gap-2 px-4 py-1 rounded-full bg-blue-50 text-blue-600 text-[10px] font-black uppercase tracking-widest mb-6">
                  <CheckCircle size={12} /> Bilimsel Yetkinlik Raporu
                </div>
                <h2 className="text-3xl md:text-4xl font-black text-slate-900 tracking-tighter mb-4">Bilim İnsanının Portresi</h2>
                <p className="text-slate-400 text-sm max-w-md mx-auto leading-relaxed">İşte bir bilim insanı olarak kuşanman gereken o kadim özellikler:</p>
              </div>

              <div className="grid md:grid-cols-2 gap-4 mb-12">
                {scientistTraits.map((trait, idx) => (
                  <div key={idx} className="group p-6 bg-slate-50/50 rounded-3xl border border-slate-100 hover:bg-white hover:shadow-xl transition-all duration-300">
                    <div className="flex items-start gap-4">
                      <div className="p-3 bg-white rounded-2xl text-blue-600 shadow-sm group-hover:scale-110 transition-transform duration-300">
                        {trait.icon}
                      </div>
                      <div>
                        <h4 className="font-bold text-slate-800 text-sm mb-1">{trait.title}</h4>
                        <p className="text-[11px] text-slate-500 leading-normal">{trait.desc}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {missedCategories.size > 0 && (
                <div className="mt-12 p-6 md:p-8 bg-blue-600 rounded-[32px] text-white shadow-2xl shadow-blue-200">
                  <div className="flex items-center gap-3 mb-6">
                    <TrendingUp size={24} />
                    <h3 className="text-lg font-black tracking-tight uppercase">Naci Hoca'nın Sana Özel Gelişim Haritası</h3>
                  </div>
                  <div className="space-y-4">
                    {Array.from(missedCategories).map((cat, idx) => (
                      <div key={idx} className="flex gap-4 items-start bg-white/10 p-4 rounded-2xl backdrop-blur-sm">
                        <div className="w-6 h-6 rounded-full bg-white text-blue-600 flex items-center justify-center text-[10px] font-black shrink-0">{idx + 1}</div>
                        <div>
                          <p className="text-[10px] font-black uppercase opacity-60 tracking-widest mb-1">{cat} Alanında Gelişim Gerekiyor:</p>
                          <p className="text-sm font-medium leading-relaxed">{recommendations[cat]}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="pt-12 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6 mt-12">
                <div className="text-center md:text-left">
                  <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Başarı Skoru</p>
                  <p className="text-4xl font-black text-blue-600">%{Math.round((score/questions.length)*100)}</p>
                </div>
                <button 
                  onClick={restartQuiz}
                  className="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-blue-600 hover:shadow-2xl hover:shadow-blue-200 transition-all active:scale-95"
                >
                  Yolculuğa Başa Dön
                </button>
              </div>
            </div>
          </div>
        )}
      </main>

      <footer className="fixed bottom-0 w-full bg-white/80 backdrop-blur-md border-t border-slate-50 py-4 text-center z-40">
        <p className="text-[10px] text-slate-400 font-black uppercase tracking-[0.4em] opacity-60">
          Hayatın pikselleri - Naci Karhan - 2026
        </p>
      </footer>

      <style dangerouslySetInnerHTML={{ __html: `
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}} />
    </div>
  );
};

export default App;
